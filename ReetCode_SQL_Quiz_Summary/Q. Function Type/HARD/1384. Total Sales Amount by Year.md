## [1384. Total Sales Amount by Year]


### Table: Product


| Column Name   | Type    |
|---------------|---------|
| product_id    | int     |
| product_name  | varchar |

product_id is the primary key (column with unique values) for this table.  
product_name is the name of the product.  
 

### Table: Sales


| Column Name         | Type    |
|---------------------|---------|
| product_id          | int     |
| period_start        | date    |
| period_end          | date    |
| average_daily_sales | int     |

product_id is the primary key (column with unique values) for this table.   
period_start and period_end indicate the start and end date for the sales period, and both dates are inclusive.  
The average_daily_sales column holds the average daily sales amount of the items for the period.  
The dates of the sales years are between 2018 to 2020.  
 
## Problem

Write a solution to report the total sales amount of each item for each year, with corresponding product_name, product_id, report_year, and total_amount.  

Return the result table ordered by product_id and report_year.  

The result format is in the following example.  



## Example 1:

### Input: 

Product table:

| product_id | product_name |
|------------|--------------|
| 1          | LC Phone     |
| 2          | LC T-Shirt   |
| 3          | LC Keychain  |

Sales table:

| product_id | period_start | period_end  | average_daily_sales |
|------------|--------------|-------------|---------------------|
| 1          | 2019-01-25   | 2019-02-28  | 100                 |
| 2          | 2018-12-01   | 2020-01-01  | 10                  |
| 3          | 2019-12-01   | 2020-01-31  | 1                   |

### Output: 

| product_id | product_name | report_year | total_amount |
|------------|--------------|-------------|--------------|
| 1          | LC Phone     |    2019     | 3500         |
| 2          | LC T-Shirt   |    2018     | 310          |
| 2          | LC T-Shirt   |    2019     | 3650         |
| 2          | LC T-Shirt   |    2020     | 10           |
| 3          | LC Keychain  |    2019     | 31           |
| 3          | LC Keychain  |    2020     | 31           |

## Explanation: 

* LC Phone was sold for the period of 2019-01-25 to 2019-02-28, and there are 35 days for this period. Total amount 35*100 = 3500. 
* LC T-shirt was sold for the period of 2018-12-01 to 2020-01-01, and there are 31, 365, 1 days for years 2018, 2019 and 2020 respectively.
* LC Keychain was sold for the period of 2019-12-01 to 2020-01-31, and there are 31, 31 days for years 2019 and 2020 respectively. 


---

<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>


## ğŸŸ¢ ë‹µì•ˆ (SQL Solution)

```sql
WITH CTE AS (
SELECT product_id, '2018' AS report_year,
       average_daily_sales * (DATEDIFF(LEAST(period_end, '2018-12-31'), GREATEST(period_start, '2018-01-01'))+1) AS total_amount
FROM Sales
WHERE YEAR(period_start) = "2018" OR YEAR(period_end) = "2018"
UNION ALL
SELECT product_id, '2019' AS report_year,
       average_daily_sales * (DATEDIFF(LEAST(period_end, '2019-12-31'), GREATEST(period_start, '2019-01-01'))+1) AS total_amount
FROM Sales
WHERE YEAR(period_start) <= '2019' AND YEAR(period_end) >= '2019'
UNION ALL
SELECT product_id, '2020' AS report_year,
       average_daily_sales * (DATEDIFF(LEAST(period_end, '2020-12-31'), GREATEST(period_start, '2020-01-01'))+1) AS total_amount
FROM Sales
WHERE YEAR(period_start) <= '2020' AND YEAR(period_end) >= '2020'
)

SELECT P1.product_id, P1.product_name, C1.report_year, C1.total_amount
FROM CTE C1 
LEFT JOIN Product P1
ON C1.product_id = P1.product_id
ORDER BY 1, 3
```

## ğŸŸ¢ í’€ì´ (Discription)

ë¶„ëª… ë¬¸ì œì˜ ì†ì„±ì„ ë³´ì•˜ì„ ë•Œ Recursiveë¥¼ ì¨ì•¼í•  ê²ƒ ê°™ì•˜ëŠ”ë°, í’€ì–´ë³´ë‹ˆê¹Œ ì¬í˜„ì´ ê°€ëŠ¥í–ˆìŠµë‹ˆë‹¤.  
ë¬¸ì œì—ì„œ ë„ì¶œë˜ëŠ” íŒíŠ¸ë“¤ì„ ì¢…í•©í•˜ë©´ ì•„ë˜ì™€ ê°™ì€ ì¡°ê±´ë“¤ì„ ì •ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.  

* ë¬¸ì œëŠ” `period_startì˜ ê°€ì¥ ë‚®ì€ ë…„ë„ ~ period_end ì˜ ê°€ì¥ ë†’ì€ ë…„ë„` ê¸°ê°„ ê°„ì˜, `average_daily_sales` ì„ ì¶œë ¥í•˜ëŠ” ë¬¸ì œì…ë‹ˆë‹¤.  
* ë‹¨ìˆœí•˜ê²Œ, ì»¬ëŸ¼ë“¤ê°„ì˜ ë‚ ì§œ ì°¨ì´ë¡œ ë°œìƒí•œ ì¼ë§Œí¼, `average_daily_sales`ì„ ê³±í•˜ì—¬ ì¶œë ¥í•˜ë©´ ë©ë‹ˆë‹¤.  
* ë”°ë¼ì„œ ë¬¸ì œì—ì„œëŠ”, 2018 ~ 2020ì˜ ë²”ìœ„ë¥¼ ê°€ì§ˆ ë•Œ ì¤‘ê°„ 2019ì— ëŒ€í•œ ì»¬ëŸ¼ì„ ë§Œë“¤ì–´ ë‚´ëŠ” ê²ƒì´ ì£¼ìš” ë¡œì§ì…ë‹ˆë‹¤.  


<br/>



#### STEP. 1 [ì—°ë„ ë³„ ë°ì´í„° êµ¬ë¶„ ë° ì§‘ê³„]  

```sql
WITH CTE AS (
SELECT product_id, '2018' AS report_year,
       average_daily_sales * (DATEDIFF(LEAST(period_end, '2018-12-31'), GREATEST(period_start, '2018-01-01'))+1) AS total_amount
FROM Sales
WHERE YEAR(period_start) = "2018" OR YEAR(period_end) = "2018"
UNION ALL
SELECT product_id, '2019' AS report_year,
       average_daily_sales * (DATEDIFF(LEAST(period_end, '2019-12-31'), GREATEST(period_start, '2019-01-01'))+1) AS total_amount
FROM Sales
WHERE YEAR(period_start) <= '2019' AND YEAR(period_end) >= '2019'
UNION ALL
SELECT product_id, '2020' AS report_year,
       average_daily_sales * (DATEDIFF(LEAST(period_end, '2020-12-31'), GREATEST(period_start, '2020-01-01'))+1) AS total_amount
FROM Sales
WHERE YEAR(period_start) <= '2020' AND YEAR(period_end) >= '2020')
```

| product_id | report_year | total_amount |
| ---------- | ----------- | ------------ |
| 2          | "2018"      | 310          |
| 1          | "2019"      | 3500         |
| 2          | "2019"      | 3650         |
| 3          | "2019"      | 31           |
| 2          | "2020"      | 10           |
| 3          | "2020"      | 31           |

ê°ê° `2018 ~ 2020` ê¹Œì§€ì˜ ë‚ ì§œì˜ ë°ì´í„° ì§‘ê³„ë¥¼ ìƒì„±í•˜ëŠ” ì¿¼ë¦¬ë¥¼ Union í•©ë‹ˆë‹¤.  

* Datediffë¡œ `2018-12-31`ê³¼ ë¹„êµí•´ì„œ, ì‘ì€ ê²ƒë¶€í„° ~ `2018-01-01` ë³´ë‹¤ í° ê²ƒ ê¹Œì§€ì˜ ì°¨ì´ë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤.  
    * +1ì˜ ê²½ìš° ë‚ ì§œì˜ ì°¨ì´ë¡œëŠ” í˜„ì¬ ë‚ ì§œê¹Œì§€ í¬í•¨ë˜ì–´ ìˆì§€ ì•Šì•„, ë‚ ì§œ ê³„ì‚°ì— +1ì„ ì¶”ê°€í•©ë‹ˆë‹¤.  

<br/>



#### STEP. 2 [JOIN - ë°ì´í„° í•„í„°ë§]  

```sql
WITH CTE AS (
SELECT product_id, '2018' AS report_year,
       average_daily_sales * (DATEDIFF(LEAST(period_end, '2018-12-31'), GREATEST(period_start, '2018-01-01'))+1) AS total_amount
FROM Sales
WHERE YEAR(period_start) = "2018" OR YEAR(period_end) = "2018"
UNION ALL
SELECT product_id, '2019' AS report_year,
       average_daily_sales * (DATEDIFF(LEAST(period_end, '2019-12-31'), GREATEST(period_start, '2019-01-01'))+1) AS total_amount
FROM Sales
WHERE YEAR(period_start) <= '2019' AND YEAR(period_end) >= '2019'
UNION ALL
SELECT product_id, '2020' AS report_year,
       average_daily_sales * (DATEDIFF(LEAST(period_end, '2020-12-31'), GREATEST(period_start, '2020-01-01'))+1) AS total_amount
FROM Sales
WHERE YEAR(period_start) <= '2020' AND YEAR(period_end) >= '2020')

SELECT P1.product_id, P1.product_name, C1.report_year, C1.total_amount
FROM CTE C1 
LEFT JOIN Product P1
ON C1.product_id = P1.product_id
ORDER BY 1, 3
```

| product_id | product_name | report_year | total_amount |
| ---------- | ------------ | ----------- | ------------ |
| 1          | LC Phone     | "2019"      | 3500         |
| 2          | LC T-Shirt   | "2018"      | 310          |
| 2          | LC T-Shirt   | "2019"      | 3650         |
| 2          | LC T-Shirt   | "2020"      | 10           |
| 3          | LC Keychain  | "2019"      | 31           |
| 3          | LC Keychain  | "2020"      | 31           |  

Unionìœ¼ë¡œ 1ì°¨ ì§‘ê³„í•œ ë°ì´í„°ë¥¼, ë¬¸ì œì˜ ì¶œë ¥ í˜•ì‹ì— ë§ê²Œ JOIN í›„, ì¶œë ¥í•©ë‹ˆë‹¤.  

<br/>




#### STEP. ì¬ê·€êµ¬í˜„

```sql
WITH RECURSIVE CTE AS
    (SELECT MIN(period_start) as date
     FROM Sales 
     UNION ALL
     SELECT DATE_ADD(date, INTERVAL 1 day)
     FROM CTE
     WHERE date <= ALL (SELECT MAX(period_end) FROM Sales))

 
SELECT 
        s.product_id, p.product_name, LEFT(e.date,4) as report_year, SUM(s.average_daily_sales) as total_amount
FROM Sales s
JOIN Product p ON p.product_id = s.product_id
JOIN CTE e ON s.period_start<=e.date AND s.period_end>=e.date
GROUP BY 1,2,3 
ORDER BY 1,3
```