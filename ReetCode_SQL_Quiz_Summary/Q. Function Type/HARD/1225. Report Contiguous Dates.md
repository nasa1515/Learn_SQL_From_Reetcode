## [1225. Report Contiguous Dates]  


### Table: Failed


| Column Name  | Type    |
|--------------|---------|
| fail_date    | date    |

fail_date is the primary key (column with unique values) for this table.  
This table contains the days of failed tasks.  
  

### Table: Succeeded


| Column Name  | Type    |
|--------------|---------|
| success_date | date    |

success_date is the primary key (column with unique values) for this table.  
This table contains the days of succeeded tasks.  
 
## Problem

A system is running one task every day. Every task is independent of the previous tasks. The tasks can fail or succeed.  

Write a solution to report the period_state for each continuous interval of days in the period from 2019-01-01 to 2019-12-31.  

period_state is 'failed' if tasks in this interval failed or 'succeeded' if tasks in this interval succeeded. Interval of days are retrieved as start_date and end_date.  

Return the result table ordered by start_date.  

The result format is in the following example.  

 

## Example 1:

### Input: 

Failed table:

| fail_date         |
|-------------------|
| 2018-12-28        |
| 2018-12-29        |
| 2019-01-04        |
| 2019-01-05        |

Succeeded table:

| success_date      |
|-------------------|
| 2018-12-30        |
| 2018-12-31        |
| 2019-01-01        |
| 2019-01-02        |
| 2019-01-03        |
| 2019-01-06        |

### Output: 

| period_state | start_date   | end_date     |
|--------------|--------------|--------------|
| succeeded    | 2019-01-01   | 2019-01-03   |
| failed       | 2019-01-04   | 2019-01-05   |
| succeeded    | 2019-01-06   | 2019-01-06   |

### Explanation: 

* The report ignored the system state in 2018 as we care about the system in the period 2019-01-01 to 2019-12-31.
* From 2019-01-01 to 2019-01-03 all tasks succeeded and the system state was "succeeded".
* From 2019-01-04 to 2019-01-05 all tasks failed and the system state was "failed".
* From 2019-01-06 to 2019-01-06 all tasks succeeded and the system state was "succeeded".



---

<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>


## ğŸŸ¢ ë‹µì•ˆ (SQL Solution)

```sql
WITH A AS (
    SELECT "succeeded" AS task, success_date AS date
    FROM Succeeded
    where success_date BETWEEN '2019-01-01' AND '2019-12-31'
    UNION ALL
    SELECT "failed" AS task, fail_date AS date
    FROM Failed
    where fail_date BETWEEN '2019-01-01' AND '2019-12-31')
    
, B AS (   
SELECT *,
     ROW_NUMBER() OVER(ORDER BY DATE) - ROW_NUMBER() OVER(PARTITION BY task ORDER BY DATE) AS rn_group
FROM A)

SELECT task AS period_state, MIN(date) AS start_date, MAX(date) AS end_date
FROM B 
GROUP BY rn_group, period_state
ORDER BY 2
```

## ğŸŸ¢ í’€ì´ (Discription)

ì•Œê³ ë¦¬ì¦˜ì„ ë– ì˜¬ë¦¬ê¸° êµ‰ì¥íˆ í˜ë“¤ì—ˆì§€ë§Œ, ë¬¸ì œì— ì§‘ì¤‘í•˜ë©´ íŠ¹ì • íŒ¨í„´ì´ ë³´ì˜€ìŠµë‹ˆë‹¤.  
ë¬¸ì œì—ì„œ ë„ì¶œë˜ëŠ” íŒíŠ¸ë“¤ì„ ì¢…í•©í•˜ë©´ ì•„ë˜ì™€ ê°™ì€ ì¡°ê±´ë“¤ì„ ì •ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.  

* ë¬¸ì œëŠ” `2019-01-01 to 2019-12-31.` ê¸°ê°„ ì¤‘ì—, `Succeeded, Failed`ì´ ë°˜ë³µë˜ì–´ ì—°ì†ë˜ëŠ” ê¸°ê°„ì„ ì¶œë ¥í•˜ëŠ” ë¬¸ì œì…ë‹ˆë‹¤.  
* ì¶œë ¥ì˜ ê²°ê³¼ë¥¼ ë³´ë©´ ì•„ë˜ì™€ ê°™ì€ íŒ¨í„´ì´ì¡´ì¬í•©ë‹ˆë‹¤.  
    * failed or succeded Tableì—ì„œ, outputì— ì¶œë ¥ëœ ë°ì´í„°ëŠ” ì—°ì†ì„±ì´ ì´ì–´ì§€ê±°ë‚˜, ê¹¨ì§„ ì‹œì ì˜ ê°€ì¥ ì‘ì€ ê°’ì´ (ì‹œì‘), í° ê°’ì´ (ë) ê°’ì´ë‹¤.  

<br/>



#### STEP. 1 [fail or success í…Œì´ë¸” êµ¬ë¶„ ë°ì´í„° ìƒì„±]  

```sql
SELECT "succeeded" AS task, success_date AS date
FROM Succeeded
where success_date BETWEEN '2019-01-01' AND '2019-12-31'
UNION ALL
SELECT "failed" AS task, fail_date AS date
FROM Failed
where fail_date BETWEEN '2019-01-01' AND '2019-12-31'
```

| task      | date       |
| --------- | ---------- |
| succeeded | 2019-01-01 |
| succeeded | 2019-01-02 |
| succeeded | 2019-01-03 |
| succeeded | 2019-01-06 |
| failed    | 2019-01-04 |
| failed    | 2019-01-05 |  

ê° í…Œì´ë¸”ì— íŠ¹ì • "success, fail" ì„ êµ¬ë¶„í•  ìˆ˜ ìˆëŠ” ë¬¸ìì—´ë¡œ êµ¬ë¶„í•©ë‹ˆë‹¤.  
ì¶”ê°€ì ìœ¼ë¡œ ë¬¸ì œì—ì„œ ëª…ì‹œëœ ë‚ ì§œ ë²”ìœ„ì˜ í•„í„°ë§ ì¡°ê±´ë„ ì ìš©í•˜ì—¬ ê°€ê³µ ë°ì´í„°ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.  

<br/>



#### STEP. 2 [consecutive Date - Window] // ì´í•´ë¥¼ ë•ê¸° ìœ„í•œ

```sql
WITH A AS (
    SELECT "succeeded" AS task, success_date AS date
    FROM Succeeded
    where success_date BETWEEN '2019-01-01' AND '2019-12-31'
    UNION ALL
    SELECT "failed" AS task, fail_date AS date
    FROM Failed
    where fail_date BETWEEN '2019-01-01' AND '2019-12-31')

SELECT *,
     ROW_NUMBER() OVER(PARTITION BY task ORDER BY DATE) AS task_rn, // ì´í•´ë¥¼ ë•ê¸° ìœ„í•œ ì»¬ëŸ¼
     ROW_NUMBER() OVER(ORDER BY DATE) AS all_rn, // ì´í•´ë¥¼ ë•ê¸°ìœ„í•œ ì»¬ëŸ¼
     ROW_NUMBER() OVER(ORDER BY DATE) - ROW_NUMBER() OVER(PARTITION BY task ORDER BY DATE) as rn_group
FROM A
```

| task      | date       | task_rn | all_rn | rn_group |
| --------- | ---------- | ------- | ------ | -------- |
| succeeded | 2019-01-01 | 1       | 1      | 0        |
| succeeded | 2019-01-02 | 2       | 2      | 0        |
| succeeded | 2019-01-03 | 3       | 3      | 0        |
| failed    | 2019-01-04 | 1       | 4      | 3        |
| failed    | 2019-01-05 | 2       | 5      | 3        |
| succeeded | 2019-01-06 | 4       | 6      | 2        |  

ë‹¤ìŒê³¼ ê°™ì€ ì¡°ê±´ì— ë”°ë¼ì„œ, ê³„ì‚°ì´ ë©ë‹ˆë‹¤.    

* task_rn -> task ë³„ë¡œ, ë‚ ì§œ ìˆœì„œëŒ€ë¡œ, Row_number ì»¬ëŸ¼ì„ ìƒì„±í•©ë‹ˆë‹¤.  
* all_rn -> ì „ì²´ í…Œì´ë¸”ì—ì„œ, ë‚ ì§œ ìˆœì„œëŒ€ë¡œ, Row_number ì»¬ëŸ¼ì„ ìƒì„±í•©ë‹ˆë‹¤.  

ê²°êµ­, ë¬¸ì œì—ì„œ ìš”êµ¬í•˜ëŠ” ê²ƒì€, ê°ê° í…Œì´ë¸” ë³„ë¡œ ì—°ì†ì„±ì„ êµ¬í•˜ëŠ” ê²ƒì´ê¸° ë•Œë¬¸ì—, ì¼ë°˜ì ìœ¼ë¡œ SQLì—ì„œ ì—°ì†ì„±ì„ êµ¬í•  ë•Œì™€ ë™ì¼í•˜ê²Œ ê³„ì‚°ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.  
`Rank()`ë‚˜ `Row_number`ë¥¼ ê¸°ì¤€ìœ¼ë¡œ, ì—°ì†ëœ ì»¬ëŸ¼ê³¼ì˜ ì°¨ì´ë¥¼ ê³„ì‚°í•˜ë©´, +1 ì”© ì¦ê°€í•˜ëŠ” Row_numberì™€ì˜ ê·¸ë£¹ì„ ê°€ì§€ê²Œ ë©ë‹ˆë‹¤.   
ìœ„ì˜ ê²½ìš°ì—ëŠ” `2019-01-01 ~ 2019-01-03` ê¹Œì§€ 1ì¼ì”© ë‚ ì§œê°€ ì¦ê°€í–ˆê³ , ì „ì²´ ì»¬ëŸ¼ì—ì„œë„ 1ì”© Row_numberê°€ ì¦ê°€í• í…Œë‹ˆ, ê°™ì€ ê·¸ë£¹ì„ ê°€ì§€ê²Œ ë©ë‹ˆë‹¤.  

<br/>  


#### STEP. 3 [consecutive Date - Window - GROUP BY MIN, MAC() ]

```sql
WITH A AS (
    SELECT "succeeded" AS task, success_date AS date
    FROM Succeeded
    where success_date BETWEEN '2019-01-01' AND '2019-12-31'
    UNION ALL
    SELECT "failed" AS task, fail_date AS date
    FROM Failed
    where fail_date BETWEEN '2019-01-01' AND '2019-12-31')
    
, B AS (   
SELECT *,
     ROW_NUMBER() OVER(ORDER BY DATE) - ROW_NUMBER() OVER(PARTITION BY task ORDER BY DATE) AS rn_group
FROM A)

SELECT task AS period_state, MIN(date) AS start_date, MAX(date) AS end_date
FROM B 
GROUP BY rn_group, period_state
ORDER BY 2
```

ê²°êµ­ Groupbyë¡œ ë¬¶ì–´ì•¼ í•˜ëŠ” ë°ì´í„°ëŠ” `rn_group (ê° ì—°ì†ì„± ì»¬ëŸ¼ë“¤ì˜ ì°¨ì´ ë°ì´í„°)`ì™€, `period_state` ë‘ ì»¬ëŸ¼ìœ¼ë¡œ,  
STEP.2ì˜ ê³¼ì •ì„ ìƒëµí•˜ì—¬, ì§‘ê³„ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.  
ë”°ë¼ì„œ, ë‘ ì»¬ëŸ¼ìœ¼ë¡œ Grouping í›„, ê° ê·¸ë£¹ì˜ `MIN() , MAX()` ê°’ì„ ì¶œë ¥í•˜ë©´ ì •ë‹µì…ë‹ˆë‹¤.  



