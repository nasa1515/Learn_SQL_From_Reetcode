## [1369. Get the Second Most Recent Activity]


### Table: UserActivity


| Column Name   | Type    |
|---------------|---------|
| username      | varchar |
| activity      | varchar |
| startDate     | Date    |
| endDate       | Date    |

This table may contain duplicates rows.  
This table contains information about the activity performed by each user in a period of time.  
A person with username performed an activity from startDate to endDate.  
 
## Problem 

Write a solution to show the second most recent activity of each user.  

If the user only has one activity, return that one. A user cannot perform more than one activity at the same time.  

Return the result table in any order.  

The result format is in the following example.  

 

## Example 1:

### Input: 

UserActivity table:

| username   | activity     | startDate   | endDate     |
|------------|--------------|-------------|-------------|
| Alice      | Travel       | 2020-02-12  | 2020-02-20  |
| Alice      | Dancing      | 2020-02-21  | 2020-02-23  |
| Alice      | Travel       | 2020-02-24  | 2020-02-28  |
| Bob        | Travel       | 2020-02-11  | 2020-02-18  |

### Output: 

| username   | activity     | startDate   | endDate     |
|------------|--------------|-------------|-------------|
| Alice      | Dancing      | 2020-02-21  | 2020-02-23  |
| Bob        | Travel       | 2020-02-11  | 2020-02-18  |

### Explanation: 

* The most recent activity of Alice is Travel from 2020-02-24 to 2020-02-28, before that she was dancing from 2020-02-21 to 2020-02-23.
* Bob only has one record, we just take that one.


---

<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>


## ğŸŸ¢ ë‹µì•ˆ (SQL Solution)

```sql
SELECT username, activity, startDate, endDate
FROM (
    SELECT *, 
        COUNT(activity) OVER(PARTITION BY username) as CT,
        RANK() OVER(PARTITION BY username ORDER BY startDate DESC) AS user_rank
    FROM UserActivity
) T
WHERE CT = 1 OR user_rank = 2
ORDER BY username

```

## ğŸŸ¢ í’€ì´ (Discription)

ë¬¸ì œì— ì •ë‹µì´ ê±°ì˜ ë‹¤ ë‚˜ì™€ ìˆì–´ì„œ, ìœ ì¶”í•˜ê³ , êµ¬í˜„í•˜ê¸° ì‰¬ìš´ ë¡œì§ì…ë‹ˆë‹¤.  
ë¬¸ì œì—ì„œ ë„ì¶œë˜ëŠ” íŒíŠ¸ë“¤ì„ ì¢…í•©í•˜ë©´ ì•„ë˜ì™€ ê°™ì€ ì¡°ê±´ë“¤ì„ ì •ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.  

* ë¬¸ì œëŠ” ë™ì¼í•œ `username`ë¥¼ ê°€ì§€ê³  ìˆëŠ” ë°ì´í„° ì¤‘ `ê°€ì¥ ìµœê·¼ì—ì„œ, ë‘ë²ˆì§¸ ë°ì´í„°`ë§Œ ì¶œë ¥í•˜ëŠ” ë¬¸ì œì…ë‹ˆë‹¤.  
* ë¬¸ì œì˜ ì¡°ê±´ì—, `startDate`ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬í•˜ëŠ” ê²ƒë„ ìˆì§€ë§Œ, ë‹¨ì¼ Rowê°€ í•œê°œì¼ ê²½ìš°ë¥¼ êµ¬ë¶„í•´ì•¼ í•©ë‹ˆë‹¤.

<br/>



#### STEP. 1 [Window Function - RANK, COUNT]  

```sql
SELECT *, 
    COUNT(activity) OVER(PARTITION BY username) as CT,
    RANK() OVER(PARTITION BY username ORDER BY startDate DESC) AS user_rank
FROM UserActivity
```

| username | activity | startDate  | endDate    | CT | user_rank |
| -------- | -------- | ---------- | ---------- | -- | --------- |
| Alice    | Travel   | 2020-02-24 | 2020-02-28 | 3  | 1         |
| Alice    | Dancing  | 2020-02-21 | 2020-02-23 | 3  | 2         |
| Alice    | Travel   | 2020-02-12 | 2020-02-20 | 3  | 3         |
| Bob      | Travel   | 2020-02-11 | 2020-02-18 | 1  | 1         |

ìœ„ì™€ ê°™ì´, ë‘ê°œì˜ í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•´ì„œ, ê°ê° `username`ì˜ row ê°œìˆ˜ì™€, `startDate` ê¸°ì¤€ ë‘ë²ˆ ì§¸ í–‰ì„ êµ¬ë¶„í•  ë°ì´í„°ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.  

<br/>


#### STEP. 2 [WHERE Filtering]  

```sql
SELECT username, activity, startDate, endDate
FROM (
    SELECT *, 
        COUNT(activity) OVER(PARTITION BY username) as CT,
        RANK() OVER(PARTITION BY username ORDER BY startDate DESC) AS user_rank
    FROM UserActivity
) T
WHERE CT = 1 OR user_rank = 2
ORDER BY username
```

| username | activity | startDate  | endDate    |
| -------- | -------- | ---------- | ---------- |
| Alice    | Dancing  | 2020-02-21 | 2020-02-23 |
| Bob      | Travel   | 2020-02-11 | 2020-02-18 |

ìœ„ì—ì„œ, ìƒì„±í•œ ë°ì´í„°ë¥¼ ê¸°ì¤€ìœ¼ë¡œ row countê°€ í•œê°œì¸ ê²ƒ, rank ê°€ 2ì¸ ê²ƒì„ í•„í„°ë§í•´ì„œ ì¶œë ¥í•©ë‹ˆë‹¤. 
