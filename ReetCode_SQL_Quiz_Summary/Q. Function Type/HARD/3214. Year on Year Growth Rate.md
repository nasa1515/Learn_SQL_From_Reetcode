## [3214. Year on Year Growth Rate]  


### Table: user_transactions


| Column Name      | Type     | 
|------------------|----------|
| transaction_id   | integer  |
| product_id       | integer  |
| spend            | decimal  |
| transaction_date | datetime |

The transaction_id column uniquely identifies each row in this table.  
Each row of this table contains the transaction ID, product ID, the spend amount, and the transaction date.  


## Problem 

Write a solution to calculate the year-on-year growth rate for the total spend for each product.    

The result table should include the following columns:  

* year: The year of the transaction.
* product_id: The ID of the product.
* curr_year_spend: The total spend for the current year.
* prev_year_spend: The total spend for the previous year.
* yoy_rate: The year-on-year growth rate percentage, rounded to 2 decimal places.

Return the result table ordered by product_id,year in ascending order.  

The result format is in the following example.  

 

## Example:

### Input:

user_transactions table:


| transaction_id | product_id | spend   | transaction_date    |
|----------------|------------|---------|---------------------|
| 1341           | 123424     | 1500.60 | 2019-12-31 12:00:00 |
| 1423           | 123424     | 1000.20 | 2020-12-31 12:00:00 |
| 1623           | 123424     | 1246.44 | 2021-12-31 12:00:00 |
| 1322           | 123424     | 2145.32 | 2022-12-31 12:00:00 |

### Output:


| year | product_id | curr_year_spend| prev_year_spend| yoy_rate |
|------|------------|----------------|----------------|----------|
| 2019 | 123424     | 1500.60        | NULL           | NULL     |
| 2020 | 123424     | 1000.20        | 1500.60        | -33.35   |
| 2021 | 123424     | 1246.44        | 1000.20        | 24.62    |
| 2022 | 123424     | 2145.32        | 1246.44        | 72.12    |

## Explanation:

* For product ID 123424:
    * In 2019:
        * Current year's spend is 1500.60
        * No previous year's spend recorded
        * YoY growth rate: NULL
    * In 2020:
        * Current year's spend is 1000.20
        * Previous year's spend is 1500.60
        * YoY growth rate: ((1000.20 - 1500.60) / 1500.60) * 100 = -33.35%
    * In 2021:
        * Current year's spend is 1246.44
        * Previous year's spend is 1000.20
        * YoY growth rate: ((1246.44 - 1000.20) / 1000.20) * 100 = 24.62%
    * In 2022:
        * Current year's spend is 2145.32
        * Previous year's spend is 1246.44
        * YoY growth rate: ((2145.32 - 1246.44) / 1246.44) * 100 = 72.12%

* Note: Output table is ordered by product_id and year in ascending order.  



---

<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>


## ğŸŸ¢ ë‹µì•ˆ (SQL Solution)

```sql
WITH CTE AS (
SELECT YEAR(transaction_date) AS year, 
       product_id,
       SUM(spend) AS curr_year_spend
FROM user_transactions
GROUP BY product_id, YEAR(transaction_date)
)

SELECT *,
       LAG(curr_year_spend, 1) OVER (PARTITION BY product_id ORDER BY year) AS prev_year_spend,
       ROUND(100 * (curr_year_spend - LAG(curr_year_spend, 1) OVER (PARTITION BY product_id ORDER BY year)) / LAG(curr_year_spend, 1) OVER (PARTITION BY product_id ORDER BY year), 2 ) AS yoy_rate
FROM CTE
```

## ğŸŸ¢ í’€ì´ (Discription)

ë¬¸ì œì—ì„œ ë„ì¶œë˜ëŠ” íŒíŠ¸ë“¤ì„ ì¢…í•©í•˜ë©´ ì•„ë˜ì™€ ê°™ì€ ì¡°ê±´ë“¤ì„ ì •ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.  

* ë¬¸ì œëŠ” ê°ê¸° `product_id`ë¡œ êµ¬ë¶„ë˜ì–´ ìˆëŠ” `transaction_date` ê¸°ê°„ ë™ì•ˆì˜ ì—°ë„ ë³„ ë°ì´í„°ë¥¼ ì „ë…„ê³¼ ë¹„êµí•˜ì—¬, ì„±ì¥ë¥ ì„ ê³„ì‚°í•˜ëŠ” ë¬¸ì œì…ë‹ˆë‹¤.  
* `product_idì™€, Yearë¡œ êµ¬ë¶„í•œ ë°ì´í„°ë¥¼ ê¸°ì¤€ìœ¼ë¡œ, ë…„ë„ ë³„ ì´í•©ì„ êµ¬í•´ì•¼ í•©ë‹ˆë‹¤.`
* `ì—°ë„ ë³„ ì´í•©`ì—ì„œ ì „ë…„ë„ì˜ ë°ì´í„° ì»¬ëŸ¼ì„ ì§‘ê³„ í•´ì•¼ í•©ë‹ˆë‹¤.  
* ì´ í›„ ì§‘ê³„ëœ ë°ì´í„°ì˜ ì†Œìˆ˜ì  ìë¦¬ìˆ˜ë¥¼ ì¡°ì •í•´ì•¼í•©ë‹ˆë‹¤.

<br/>



#### STEP. 1 [GROUP BY ì—°ë„ ë³„ ì§‘ê³„ ë°ì´í„° ìƒì„±]  

```sql
SELECT YEAR(transaction_date) AS year, 
       product_id,
       SUM(spend) AS curr_year_spend
FROM user_transactions
GROUP BY product_id, YEAR(transaction_date)
```  

| year | product_id | curr_year_spend |
| ---- | ---------- | --------------- |
| 2018 | 1005       | 9488.66         |
| 2019 | 1005       | 1073.81         |
| 2020 | 1005       | 7694.48         |
| 2021 | 1005       | 7366.6          |
| 2022 | 1005       | 4919.38         |
| 2018 | 1006       | 2193.49         |
| 2019 | 1006       | 3075.41         |
| 2020 | 1006       | 5421.12         |
| 2021 | 1006       | 3160.11         |
| 2022 | 1006       | 4585.72         |  

ë‹¤ìŒê³¼ ê°™ì´, ì—¬ëŸ¬ ë‹¬, ì¼ ë³„ë¡œ ë¶„ì‚°ë˜ì–´ ìˆëŠ” ë°ì´í„°ë¥¼ `YEAR`ë¡œ Groupingí•´ì„œ, ê·¸ í•©ê³„ë¥¼ ì§‘ê³„í•´, `curr_year_spend`ë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤.  

<br/>



#### STEP. 2 [LAG(), Round ì§‘ê³„]  

```sql
WITH CTE AS (
SELECT YEAR(transaction_date) AS year, 
       product_id,
       SUM(spend) AS curr_year_spend
FROM user_transactions
GROUP BY product_id, YEAR(transaction_date)
)

SELECT *,
       LAG(curr_year_spend, 1) OVER (PARTITION BY product_id ORDER BY year) AS prev_year_spend,
       ROUND(100 * (curr_year_spend - LAG(curr_year_spend, 1) OVER (PARTITION BY product_id ORDER BY year)) / LAG(curr_year_spend, 1) OVER (PARTITION BY product_id ORDER BY year), 2 ) AS yoy_rate
FROM CTE
```

| year | product_id | curr_year_spend | prev_year_spend | yoy_rate |
| ---- | ---------- | --------------- | --------------- | -------- |
| 2018 | 1001       | 1064.72         | null            | null     |
| 2019 | 1001       | 4662.87         | 1064.72         | 337.94   |
| 2020 | 1001       | 5260.97         | 4662.87         | 12.83    |
| 2021 | 1001       | 12749.97        | 5260.97         | 142.35   |
| 2022 | 1001       | 7630.2          | 12749.97        | -40.16   |
| 2018 | 1002       | 6164.28         | null            | null     |
| 2019 | 1002       | 1224.39         | 6164.28         | -80.14   |
| 2020 | 1002       | 3195.49         | 1224.39         | 160.99   |
| 2021 | 1002       | 9226.67         | 3195.49         | 188.74   |
| 2022 | 1002       | 1816.12         | 9226.67         | -80.32   |

`LAG()` í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•´ì„œ, `product_id` ì™€ `year` ì»¬ëŸ¼ì˜ ìˆœì„œ ìƒ ë°”ë¡œ ì´ì „ í–‰ì— í•´ë‹¹í•˜ëŠ” ë°ì´í„° ì»¬ëŸ¼ì„ `prev_year_spend`ë¡œ ìƒì„±í•©ë‹ˆë‹¤.  
ì´í›„, Roundë¥¼ ì´ìš©í•´ì„œ `yoy_rate` ì§‘ê³„ê°’ì— ëŒ€í•œ ì†Œìˆ˜ì  ìë¦¬ìˆ˜ë¥¼ ì¡°ì •í•˜ì—¬ ì¶œë ¥í•˜ë©´ ì •ë‹µì…ë‹ˆë‹¤.