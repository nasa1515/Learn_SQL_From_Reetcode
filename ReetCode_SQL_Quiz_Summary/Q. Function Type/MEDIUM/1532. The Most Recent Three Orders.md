## [1532. The Most Recent Three Orders]  


### Table: Customers


| Column Name   | Type    |
|---------------|---------|
| customer_id   | int     |
| name          | varchar |

customer_id is the column with unique values for this table.  
This table contains information about customers.  
 

### Table: Orders


| Column Name   | Type    |
|---------------|---------|
| order_id      | int     |
| order_date    | date    |
| customer_id   | int     |
| cost          | int     |

order_id is the column with unique values for this table.  
This table contains information about the orders made by customer_id.  
Each customer has one order per day.  
 
## Problem 

Write a solution to find the most recent three orders of each user. If a user ordered less than three orders, return all of their orders.  

Return the result table ordered by customer_name in ascending order and in case of a tie by the customer_id in ascending order. If there is still a tie, order them by order_date in descending order.  

The result format is in the following example.  

 

## Example 1:

### Input: 

Customers table:


| customer_id | name      |
|-------------|-----------|
| 1           | Winston   |
| 2           | Jonathan  |
| 3           | Annabelle |
| 4           | Marwan    |
| 5           | Khaled    |

Orders table:

| order_id | order_date | customer_id | cost |
|----------|------------|-------------|------|
| 1        | 2020-07-31 | 1           | 30   |
| 2        | 2020-07-30 | 2           | 40   |
| 3        | 2020-07-31 | 3           | 70   |
| 4        | 2020-07-29 | 4           | 100  |
| 5        | 2020-06-10 | 1           | 1010 |
| 6        | 2020-08-01 | 2           | 102  |
| 7        | 2020-08-01 | 3           | 111  |
| 8        | 2020-08-03 | 1           | 99   |
| 9        | 2020-08-07 | 2           | 32   |
| 10       | 2020-07-15 | 1           | 2    |

### Output: 

| customer_name | customer_id | order_id | order_date |
|---------------|-------------|----------|------------|
| Annabelle     | 3           | 7        | 2020-08-01 |
| Annabelle     | 3           | 3        | 2020-07-31 |
| Jonathan      | 2           | 9        | 2020-08-07 |
| Jonathan      | 2           | 6        | 2020-08-01 |
| Jonathan      | 2           | 2        | 2020-07-30 |
| Marwan        | 4           | 4        | 2020-07-29 |
| Winston       | 1           | 8        | 2020-08-03 |
| Winston       | 1           | 1        | 2020-07-31 |
| Winston       | 1           | 10       | 2020-07-15 |

### Explanation: 

* Winston has 4 orders, we discard the order of "2020-06-10" because it is the oldest order.
* Annabelle has only 2 orders, we return them.
* Jonathan has exactly 3 orders.
* Marwan ordered only one time.
* We sort the result table by customer_name in ascending order, by customer_id in ascending order, and by order_date in descending order in case of a tie.  
 
Follow up: Could you write a general solution for the most recent n orders?



<br/>

---

<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>


## ğŸŸ¢ ë‹µì•ˆ (SQL Solution)

```sql
SELECT customer_name, customer_id, order_id, order_date
FROM (
    SELECT name AS customer_name, C1.customer_id, O1.order_id, O1.order_date,
        ROW_NUMBER() OVER(PARTITION BY O1.customer_id ORDER BY O1.order_date DESC) AS RN
    FROM Orders O1
    JOIN Customers C1
    ON O1.customer_id = C1.customer_id
    ) T
WHERE RN <= 3
ORDER BY customer_name ASC, customer_id ASC, order_date DESC
```

## ğŸŸ¢ í’€ì´ (Discription)

ë¬¸ì œì—ì„œ ì•„ë˜ì˜ íŒíŠ¸ ì¡°ê±´ì„ ì°¾ì•„ì„œ, ì¡°ê±´ì— ë§ëŠ” ë¡œì§ì„ êµ¬í˜„í•˜ë©´ ë¬¸ì œ í’€ì´ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.  

* Customers Tableê³¼ Ordersì€ `customer_id`ë¥¼ ê¸°ì¤€ìœ¼ë¡œ Join ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.  
* ë™ì¼í•œ `customer_id`ë¥¼ ê°€ì§„ ROWSëŠ” `order_date`ì˜ ì˜¤ë¦„ì°¨ìˆœ ë°ì´í„°ë¥¼ ê¸°ì¤€ìœ¼ë¡œ 3ê°œê¹Œì§€ ì¶œë ¥ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.  

<br/>

---

#### STEP. 1 [JOIN]

```sql
SELECT *
FROM Orders O1
JOIN Customers C1
ON O1.customer_id = C1.customer_id
```

| order_id | order_date | customer_id | cost | customer_id | name      |
| -------- | ---------- | ----------- | ---- | ----------- | --------- |
| 1        | 2020-07-31 | 1           | 30   | 1           | Winston   |
| 2        | 2020-07-30 | 2           | 40   | 2           | Jonathan  |
| 3        | 2020-07-31 | 3           | 70   | 3           | Annabelle |
| 4        | 2020-07-29 | 4           | 100  | 4           | Marwan    |
| 5        | 2020-06-10 | 1           | 1010 | 1           | Winston   |
| 6        | 2020-08-01 | 2           | 102  | 2           | Jonathan  |
| 7        | 2020-08-01 | 3           | 111  | 3           | Annabelle |
| 8        | 2020-08-03 | 1           | 99   | 1           | Winston   |
| 9        | 2020-08-07 | 2           | 32   | 2           | Jonathan  |
| 10       | 2020-07-15 | 1           | 2    | 1           | Winston   |  

ë‹¨ìˆœí•˜ê²Œ, ë¬¸ì œì˜ ì¡°ê±´ì„ ìœ„í•´ì„œ `customer_id` ê¸°ì¤€ìœ¼ë¡œ JOINí•´ `name` ì»¬ëŸ¼ì„ ë¶™ì—¬ì¤ë‹ˆë‹¤.  

<br/>

---


#### STEP. 2 [Window ROW_NUMBER()]

```sql
SELECT name AS customer_name, C1.customer_id, O1.order_id, O1.order_date,
    ROW_NUMBER() OVER(PARTITION BY O1.customer_id ORDER BY O1.order_date DESC) AS RN
FROM Orders O1
JOIN Customers C1
ON O1.customer_id = C1.customer_id
```

| customer_name | customer_id | order_id | order_date | RN |
| ------------- | ----------- | -------- | ---------- | -- |
| Winston       | 1           | 8        | 2020-08-03 | 1  |
| Winston       | 1           | 1        | 2020-07-31 | 2  |
| Winston       | 1           | 10       | 2020-07-15 | 3  |
| Winston       | 1           | 5        | 2020-06-10 | 4  |
| Jonathan      | 2           | 9        | 2020-08-07 | 1  |
| Jonathan      | 2           | 6        | 2020-08-01 | 2  |
| Jonathan      | 2           | 2        | 2020-07-30 | 3  |
| Annabelle     | 3           | 7        | 2020-08-01 | 1  |
| Annabelle     | 3           | 3        | 2020-07-31 | 2  |
| Marwan        | 4           | 4        | 2020-07-29 | 1  |

ë™ì¼í•˜ê²Œ ë¬¸ì œì˜ ì¡°ê±´ì— ë§ê²Œ, `order_date` ê¸°ì¤€ì˜ `customer_id`ì˜ ìµœê·¼ ë°ì´í„°ë¥¼ ì¡°íšŒí•˜ê¸° ìœ„í•´  
RNì´ë¼ê³  í•˜ëŠ” Row_number ì»¬ëŸ¼ì„ ì¶”ê°€í•©ë‹ˆë‹¤. ì´ ê²½ìš° RNì´ 3ë³´ë‹¤ ì‘ê±°ë‚˜ ê°™ì€ ê²½ìš°ë§Œ ì¶œë ¥í•˜ë©´ ë©ë‹ˆë‹¤.  

<br/>

---


#### STEP. 3 [WHERE FILTER]

```sql
SELECT customer_name, customer_id, order_id, order_date
FROM (
    SELECT name AS customer_name, C1.customer_id, O1.order_id, O1.order_date,
        ROW_NUMBER() OVER(PARTITION BY O1.customer_id ORDER BY O1.order_date DESC) AS RN
    FROM Orders O1
    JOIN Customers C1
    ON O1.customer_id = C1.customer_id
    ) T
WHERE RN <= 3
ORDER BY customer_name ASC, customer_id ASC, order_date DESC
```

| customer_name | customer_id | order_id | order_date |
| ------------- | ----------- | -------- | ---------- |
| Annabelle     | 3           | 7        | 2020-08-01 |
| Annabelle     | 3           | 3        | 2020-07-31 |
| Jonathan      | 2           | 9        | 2020-08-07 |
| Jonathan      | 2           | 6        | 2020-08-01 |
| Jonathan      | 2           | 2        | 2020-07-30 |
| Marwan        | 4           | 4        | 2020-07-29 |
| Winston       | 1           | 8        | 2020-08-03 |
| Winston       | 1           | 1        | 2020-07-31 |
| Winston       | 1           | 10       | 2020-07-15 |

ìµœì¢…ì ìœ¼ë¡œ, `WHERE`ì„ ì‚¬ìš©í•´ì„œ í•„í„°ë§ í•œë’¤, ì •ë ¬ ì¡°ê±´ì— ë§ì¶°ì„œ ì •ë ¬í•˜ë©´ ì •ë‹µì…ë‹ˆë‹¤.