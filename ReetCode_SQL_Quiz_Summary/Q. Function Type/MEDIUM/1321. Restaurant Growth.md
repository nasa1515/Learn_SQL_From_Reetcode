## [1321. Restaurant Growth]

### Table: Customer


| Column Name   | Type    |
|---------------|---------|
| customer_id   | int     |
| name          | varchar |
| visited_on    | date    |
| amount        | int     |

In SQL,(customer_id, visited_on) is the primary key for this table.  
This table contains data about customer transactions in a restaurant.  
visited_on is the date on which the customer with ID (customer_id) has visited the restaurant.  
amount is the total paid by a customer.  
 
## Problem 

You are the restaurant owner and you want to analyze a possible expansion (there will be at least one customer every day).  

Compute the moving average of how much the customer paid in a seven days window (i.e., current day | 6 days before).  
average_amount should be rounded to two decimal places.  

Return the result table ordered by visited_on in ascending order.  

The result format is in the following example.  

 

## Example 1:

### Input: 

Customer table:

| customer_id | name         | visited_on   | amount      |
|-------------|--------------|--------------|-------------|
| 1           | Jhon         | 2019-01-01   | 100         |
| 2           | Daniel       | 2019-01-02   | 110         |
| 3           | Jade         | 2019-01-03   | 120         |
| 4           | Khaled       | 2019-01-04   | 130         |
| 5           | Winston      | 2019-01-05   | 110         | 
| 6           | Elvis        | 2019-01-06   | 140         | 
| 7           | Anna         | 2019-01-07   | 150         |
| 8           | Maria        | 2019-01-08   | 80          |
| 9           | Jaze         | 2019-01-09   | 110         | 
| 1           | Jhon         | 2019-01-10   | 130         | 
| 3           | Jade         | 2019-01-10   | 150         | 

### Output: 

| visited_on   | amount       | average_amount |
|--------------|--------------|----------------|
| 2019-01-07   | 860          | 122.86         |
| 2019-01-08   | 840          | 120            |
| 2019-01-09   | 840          | 120            |
| 2019-01-10   | 1000         | 142.86         |

### Explanation: 
* 1st moving average from 2019-01-01 to 2019-01-07 has an average_amount of (100 | 110 | 120 | 130 | 110 | 140 | 150)/7 = 122.86
* 2nd moving average from 2019-01-02 to 2019-01-08 has an average_amount of (110 | 120 | 130 | 110 | 140 | 150 | 80)/7 = 120
* 3rd moving average from 2019-01-03 to 2019-01-09 has an average_amount of (120 | 130 | 110 | 140 | 150 | 80 | 110)/7 = 120
* 4th moving average from 2019-01-04 to 2019-01-10 has an average_amount of (130 | 110 | 140 | 150 | 80 | 110 | 130 | 150)/7 = 142.86


<br/>

---

<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>


## ğŸŸ¢ ë‹µì•ˆ (SQL Solution)

```sql
SELECT DISTINCT(visited_on),
       SUM(amount) OVER (ORDER BY visited_on RANGE BETWEEN INTERVAL 6 DAY PRECEDING AND CURRENT ROW) AS amount,
       ROUND(SUM(amount) OVER (ORDER BY visited_on RANGE BETWEEN INTERVAL 6 DAY PRECEDING AND CURRENT ROW)/7,2) AS average_amount
FROM Customer
    ORDER BY visited_on
    LIMIT 1000
    OFFSET 6
```

## ğŸŸ¢ í’€ì´ (Discription)
`WINDOW`ë¥¼ ì‚¬ìš©í•´ì„œ `visited_on` ì»¬ëŸ¼ì˜ ê°’ ë²”ìœ„ì˜ 7ì¼ ê°„ì˜ í•©ê³„ì™€, í‰ê·  ê°’ì„ í•„í„°ë§í•´ì„œ ë°ì´í„°ë¥¼ ì§‘ê³„í•´ í•´ê²°í–ˆìŠµë‹ˆë‹¤.   
ë¬¸ì œì—ì„œ ë‚˜ì˜¨ ì¡°ê±´ì— ë”°ë¼ì„œ, í’€ì´ë¥¼ ëŒ€ì‹ í•˜ê² ìŠµë‹ˆë‹¤. 

* #### 1. Window : `visited_on`ì„ ê¸°ì¤€ìœ¼ë¡œ 7ì¼ê°„ì˜ ë°ì´í„°ë¥¼ ì§‘ê³„í•´ì•¼ í•˜ë‹ˆ, `OVER()` ì ˆë§Œ ì‚¬ìš©í•´ì„œ ì§‘ê³„í–ˆìŠµë‹ˆë‹¤. -> `PARTITION BY` ê°™ì´ ë…¼ë¦¬ì ì€ Groupingì€ í•„ìš” ì—†ëŠ” ë¬¸ì œ ì˜€ìŠµë‹ˆë‹¤.  

* #### 2. Window frame : í˜„ì¬ ë‚ ì§œ (Current date)ë¥¼ í¬í•¨í•œ, 7ì¼ ë™ì¼ì˜ `í•©ê³„(sum)`, `í‰ê· (avg)`ì— ëŒ€í•œ ê³„ì‚° ê°’ì´ í•„ìš”í•©ë‹ˆë‹¤. -> ë”°ë¼ì„œ `visited_on`ì´ë¼ëŠ” ì—°ì†ì ì¸ ë°ì´í„°ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë¶„í•  í–ˆìŠµë‹ˆë‹¤. `RANGE BETWEEN INTERVAL 6 DAY PRECEDING AND CURRENT ROW`

* #### 3. `sum(aoumt/7)` ì§‘ê³„ì˜ ì´ìœ , -> `avg()`ë¡œë„ í‰ê· ì„ êµ¬í•  ìˆ˜ ìˆì§€ë§Œ, ë‚˜ëˆˆ `Window frame`ì—ëŠ” 7ì¼ ì´ë¼ê³ , 7ê°œì˜ ë°ì´í„°ë§Œ ì¡´ì¬í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.  

* #### 4. `limit & offset` -> ê°€ì¥ ì²˜ìŒ ì¼ìë¥¼ ê¸°ì¤€ìœ¼ë¡œ, 7ì¼ ì´í›„ì˜ ê°’ì„ ì¶œë ¥í•´ì•¼ í•˜ê¸°ì—, 7ì¼ ì´í›„ì˜ ê°’ -> `OFFSET 6`ìœ¼ë¡œ êµ¬í˜„í–ˆìŠµë‹ˆë‹¤.  

* #### 5. `DISCTINCT` -> GROUPBY ì™€ëŠ” ë‹¤ë¥´ê²Œ, Window í•¨ìˆ˜ë¡œ í‘œí˜„ëœ ë°ì´í„°ëŠ” Grouping ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë”°ë¼ì„œ ìœ ì¼í•œ ê°’ì„ ì–»ê¸° ìœ„í•œ í•¨ìˆ˜ ì…ë‹ˆë‹¤.  

### Window í•¨ìˆ˜ì˜ SQL 

```sql
SELECT visited_on,
       SUM(amount) OVER (ORDER BY visited_on RANGE BETWEEN INTERVAL 6 DAY PRECEDING AND CURRENT ROW) AS amount
FROM Customer
ORDER BY visited_on
```
ë‹¤ìŒê³¼ ê°™ì´, `INTERVAL 6 DAY PRECEDING` 6ì¼ ì „ë¶€í„° ~ `CURRENT ROW` í˜„ì¬ê°€ì§€ì˜ ê°’ì˜ í•©ì„ êµ¬í•˜ë©´.  

### Window í•¨ìˆ˜ì˜ SQL ê²°ê³¼

| visited_on | amount |
| ---------- | ------ |
| 2019-01-01 | 100    |
| 2019-01-02 | 210    |
| 2019-01-03 | 330    |
| 2019-01-04 | 460    |
| 2019-01-05 | 570    |
| 2019-01-06 | 710    |
| 2019-01-07 | 860    |
| 2019-01-08 | 840    |
| 2019-01-09 | 840    |
| 2019-01-10 | 1000   |
| 2019-01-10 | 1000   |  

ìœ„ ì²˜ëŸ¼, ê° ì¼ì ë³„ë¡œ ì¼ì£¼ì¼ ê°„ì˜ ëˆ„ì  í•©ì´ ê³„ì‚° ë©ë‹ˆë‹¤.    
í•˜ì§€ë§Œ WindowëŠ” Groupby ì™€ ê°™ì´ Grouping ëœ ë°ì´í„°ì˜ ì¶•ì•½ê¹Œì§€ ì§€ì›í•˜ì§€ ì•Šì•„ `2019-01-10`ê³¼ ê°™ì´ ì¤‘ë³µì´ ìˆìŠµë‹ˆë‹¤.  

### + `DISTINCT()`ë¥¼ í¬í•¨í•œ Window í•¨ìˆ˜ì˜ SQL ê²°ê³¼

| visited_on | amount |
| ---------- | ------ |
| 2019-01-01 | 100    |
| 2019-01-02 | 210    |
| 2019-01-03 | 330    |
| 2019-01-04 | 460    |
| 2019-01-05 | 570    |
| 2019-01-06 | 710    |
| 2019-01-07 | 860    |
| 2019-01-08 | 840    |
| 2019-01-09 | 840    |
| 2019-01-10 | 1000   |

ìœ„ì²˜ëŸ¼, íŠ¹ì • ì»¬ëŸ¼ì„ ê¸°ì¤€ìœ¼ë¡œ `DISTINCT`ë¥¼ í•˜ê²Œ ë˜ë©´, Groupbyì™€ ë™ì¼í•œ ì¶œë ¥ì„ ì–»ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.