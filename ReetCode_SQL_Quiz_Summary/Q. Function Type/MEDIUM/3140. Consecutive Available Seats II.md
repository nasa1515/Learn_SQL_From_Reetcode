## [3140. Consecutive Available Seats II]  


### Table: Cinema


| Column Name | Type |
|-------------|------|
| seat_id     | int  |
| free        | bool |

seat_id is an auto-increment column for this table.  
Each row of this table indicates whether the ith seat is free or not. 1 means free while 0 means occupied.  

## Problem

Write a solution to find the length of longest consecutive sequence of available seats in the cinema.  

Note:

* There will always be at most one longest consecutive sequence.
* If there are multiple consecutive sequences with the same length, include all of them in the output.

Return the result table ordered by first_seat_id in ascending order.  

The result format is in the following example.  

 

## Example:

### Input:

Cinema table:


| seat_id | free |
|---------|------|
| 1       | 1    |
| 2       | 0    |
| 3       | 1    |
| 4       | 1    |
| 5       | 1    |

### Output:


| first_seat_id   | last_seat_id   | consecutive_seats_len |
|-----------------|----------------|-----------------------|
| 3               | 5              | 3                     |

### Explanation:

* Longest consecutive sequence of available seats starts from seat 3 and ends at seat 5 with a length of 3.
* Output table is ordered by first_seat_id in ascending order.  



---

<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>


## ğŸŸ¢ ë‹µì•ˆ (SQL Solution)

```sql
WITH CTE AS (
SELECT *, 
       seat_id - ROW_NUMBER() OVER(PARTITION BY free ORDER BY seat_id ASC) AS rn_con
FROM Cinema 
WHERE free != 0
),

RN_TABLE AS (
SELECT MIN(seat_id) AS first_seat_id, 
       MAX(seat_id) AS last_seat_id,
       COUNT(seat_id) AS consecutive_seats_len,
       DENSE_RANK() OVER(ORDER BY COUNT(seat_id) DESC) AS rn_rank
FROM CTE
GROUP BY rn_con 
ORDER BY first_seat_id
)

SELECT first_seat_id, last_seat_id, consecutive_seats_len
FROM RN_TABLE
WHERE rn_rank = 1
```

## ğŸŸ¢ í’€ì´ (Discription)

ë¬¸ì œì—ì„œ ë„ì¶œë˜ëŠ” íŒíŠ¸ë“¤ì„ ì¢…í•©í•˜ë©´ ì•„ë˜ì™€ ê°™ì€ ì¡°ê±´ë“¤ì„ ì •ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.  

* ë¬¸ì œëŠ” `Cinema` í…Œì´ë¸”ì—ì„œ, free ì»¬ëŸ¼ì˜ ê°’ì´ 1ì¸ ë°ì´í„°ë“¤ì˜ ìµœëŒ€ ì—°ì†ì„±ì„ êµ¬í•œ ë’¤, ê°€ì¥ ë†’ì€ ì—°ì†ì„±ì„ ê°€ì§„ ë°ì´í„°ë§Œ ì¶œë ¥í•˜ëŠ” ë¬¸ì œì…ë‹ˆë‹¤.  
* free ê°’ì´ 0ì¸ ê²½ìš°ëŠ” ì œì™¸í•´ì•¼ í•©ë‹ˆë‹¤.
* seat_idëŠ” 1ì”© ìˆœì°¨ì ìœ¼ë¡œ ì¦ê°€í•©ë‹ˆë‹¤.

<br/>



#### STEP. 1 [ ë°ì´í„° ì—°ì†ì„± Grouping ]  

```sql
SELECT *, 
       seat_id - ROW_NUMBER() OVER(PARTITION BY free ORDER BY seat_id ASC) AS rn_con
FROM Cinema 
WHERE free != 0
```

| seat_id | free | rn_con |
| ------- | ---- | ------ |
| 1       | 1    | 0      |
| 3       | 1    | 1      |
| 4       | 1    | 1      |
| 5       | 1    | 1      |

SQLì—ì„œ ìì£¼ë³´ë˜ íŒ¨í„´ì…ë‹ˆë‹¤. ìˆœì°¨ì ìœ¼ë¡œ ëŠ˜ì–´ë‚˜ëŠ” `seat_id`ì™€ ë™ì¼í•˜ê²Œ ìˆœì°¨ì ìœ¼ë¡œ ëŠ˜ì–´ë‚˜ëŠ” `ROW_NUMBER` ê°’ì„ ë¹„êµí•´ì„œ,  
ê·¸ ì°¨ì´ê°€ ë™ì¼í•œ ë°ì´í„° ë¼ë¦¬ Groupingì„ ë§ºìœ¼ë©´, ì—°ì†ì„± ë°ì´í„°ë¥¼ í•„í„°ë§í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.  

<br/>  


#### STEP. 2 [ ë°ì´í„° ì§‘ê³„ ë° Ranking() ]  

```sql
WITH CTE AS (
SELECT *, 
       seat_id - ROW_NUMBER() OVER(PARTITION BY free ORDER BY seat_id ASC) AS rn_con
FROM Cinema 
WHERE free != 0
)

SELECT MIN(seat_id) AS first_seat_id, 
       MAX(seat_id) AS last_seat_id,
       COUNT(seat_id) AS consecutive_seats_len,
       DENSE_RANK() OVER(ORDER BY COUNT(seat_id) DESC) AS rn_rank
FROM CTE
GROUP BY rn_con 
ORDER BY first_seat_id
```

| first_seat_id | last_seat_id | consecutive_seats_len | rn_rank |
| ------------- | ------------ | --------------------- | ------- |
| 1             | 1            | 1                     | 2       |
| 3             | 5            | 3                     | 1       |

ë‹¤ìŒê³¼ ê°™ì´, `rn_con` ê°’ ë¼ë¦¬ì˜ Grouping ë°ì´í„°ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ê° `MIN, MAC, COUNT` ê°’ì„ ì§‘ê³„í•©ë‹ˆë‹¤.  
ë˜í•œ, ê°€ì¥ ë†’ì€ ì—°ì†ì„±ì„ ê°€ì§„ ë°ì´í„°ë¥¼ ì¶œë ¥í•´ì•¼í•˜ê¸°ì—, `COUNT`ë¥¼ ê¸°ì¤€ìœ¼ë¡œ Ranking ë°ì´í„°ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.

<br/>

#### STEP. 3 [ WHERE() ]  

```sql

WITH CTE AS (
    SELECT *, 
        seat_id - ROW_NUMBER() OVER(PARTITION BY free ORDER BY seat_id ASC) AS rn_con
    FROM Cinema 
    WHERE free != 0
    )
,
RN_TABLE AS (
    SELECT MIN(seat_id) AS first_seat_id, 
        MAX(seat_id) AS last_seat_id,
        COUNT(seat_id) AS consecutive_seats_len,
        DENSE_RANK() OVER(ORDER BY COUNT(seat_id) DESC) AS rn_rank
    FROM CTE
    GROUP BY rn_con 
    ORDER BY first_seat_id
)

SELECT first_seat_id, last_seat_id, consecutive_seats_len
FROM RN_TABLE
WHERE rn_rank = 1
```

| first_seat_id | last_seat_id | consecutive_seats_len |
| ------------- | ------------ | --------------------- |
| 3             | 5            | 3                     |

ìµœì¢…ì ìœ¼ë¡œ `WHERE` ì¡°ê±´ìœ¼ë¡œ RANK ê°’ì´ ê°€ì¥ ë†’ì€ ë°ì´í„°ë¥¼ ì¶œë ¥í•˜ë©´ ì •ë‹µì…ë‹ˆë‹¤.