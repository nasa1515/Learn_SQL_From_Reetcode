## [1127. User Purchase Platform]  


### Table: Spending


| Column Name | Type    |
|-------------|---------|
| user_id     | int     |
| spend_date  | date    |
| platform    | enum    | 
| amount      | int     |

The table logs the history of the spending of users that make purchases from an online shopping website that has a desktop and a mobile application.  
(user_id, spend_date, platform) is the primary key (combination of columns with unique values) of this table.  
The platform column is an ENUM (category) type of ('desktop', 'mobile').  
 
## Problem

Write a solution to find the total number of users and the total amount spent using the mobile only, the desktop only, and both mobile and desktop together for each date.  

Return the result table in any order.  

The result format is in the following example.  

 

## Example 1:

### Input: 

Spending table:

| user_id | spend_date | platform | amount |
|---------|------------|----------|--------|
| 1       | 2019-07-01 | mobile   | 100    |
| 1       | 2019-07-01 | desktop  | 100    |
| 2       | 2019-07-01 | mobile   | 100    |
| 2       | 2019-07-02 | mobile   | 100    |
| 3       | 2019-07-01 | desktop  | 100    |
| 3       | 2019-07-02 | desktop  | 100    |

### Output: 

| spend_date | platform | total_amount | total_users |
|------------|----------|--------------|-------------|
| 2019-07-01 | desktop  | 100          | 1           |
| 2019-07-01 | mobile   | 100          | 1           |
| 2019-07-01 | both     | 200          | 1           |
| 2019-07-02 | desktop  | 100          | 1           |
| 2019-07-02 | mobile   | 100          | 1           |
| 2019-07-02 | both     | 0            | 0           |
 
### Explanation:

* On 2019-07-01, user 1 purchased using both desktop and mobile, user 2 purchased using mobile only and user 3 purchased using desktop only.
* On 2019-07-02, user 2 purchased using mobile only, user 3 purchased using desktop only and no one purchased using both platforms.  


---

<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>


## ğŸŸ¢ ë‹µì•ˆ (SQL Solution)

```sql
SELECT P1.spend_date, P1.platform, IFNULL(SUM(T2.total_amount), 0) AS total_amount, COUNT(user_id) total_users
FROM (
    SELECT DISTINCT spend_date, 'desktop' platform FROM Spending
    UNION ALL
    SELECT DISTINCT spend_date, 'mobile' platform FROM Spending
    UNION ALL
    SELECT DISTINCT spend_date, 'both' platform FROM Spending
) P1
LEFT JOIN (
    SELECT *,
        IF(mobile > 0, IF(desktop > 0, 'both', 'mobile'), 'desktop') AS platform,
        (mobile+desktop) AS total_amount
    FROM 
        (
        SELECT user_id, spend_date,
            SUM(CASE WHEN platform = 'mobile' THEN amount ELSE 0 END) AS mobile,
            SUM(CASE WHEN platform = 'desktop' THEN amount ELSE 0 END) AS desktop
        FROM Spending
        GROUP BY user_id, spend_date
    ) T1
) T2
ON P1.platform = T2.platform AND P1.spend_date = T2.spend_date
GROUP BY spend_date, platform
```

## ğŸŸ¢ í’€ì´ (Discription)

ì œ ê°œì¸ì ìœ¼ë¡œ, leetcodeì˜ SQL ë¬¸ì œ ì¤‘ ê°€ì¥ ì•…ë„í•œ ë¬¸ì œì¸ ê²ƒ ê°™ìŠµë‹ˆë‹¤.  
ê°„ë‹¨í•˜ê²Œ ë¬¸ì œ ì†ì—ì„œ ì•„ë˜ì™€ ê°™ì€ íŒíŠ¸ë“¤ì„ ë°œê²¬í•œ ë’¤ ë‚˜ì—´í•˜ì—¬ êµ¬í˜„í•˜ë©´ ì‰½ê²Œ í’€ì´ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.  

* ë¬¸ì œëŠ”, `Spending` í…Œì´ë¸”ì—ì„œ ê° `spend_date` ë³„ë¡œ `platform` ë°ì´í„°ì˜ ì¤‘ë³µ ì—¬ë¶€ë¥¼ ì¶œë ¥í•˜ëŠ” ë¬¸ì œì…ë‹ˆë‹¤.  
    * ê°€ë ¹ ì˜ˆë¥¼ ë“¤ë©´, `spend_date=2019-07-01` ì˜ ê²½ìš° bothë„ í•˜ë‚˜ ìˆê³  mobile, desktopë„ í•˜ë‚˜ì”© ìˆëŠ” ê²½ìš°ì…ë‹ˆë‹¤.  

* output ì¶œë ¥ì„ ë´¤ì„ ë•Œ, ë¬´ì¡°ê±´ Union í•œ ê²°ê³¼ì— LEFT JOINì„ í•´ì•¼í•©ë‹ˆë‹¤. -> 2019-07-02ì˜ ê²½ìš° bothê°€ ì—†ëŠ” ê²½ìš°ë„ ì¶œë ¥í•´ì•¼í•˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.


<br/>



#### STEP. 1 [user_id, spend_date ë³„ spend ì»¬ëŸ¼ ì§‘ê³„]  

```sql
SELECT user_id, spend_date,
    SUM(CASE WHEN platform = 'mobile' THEN amount ELSE 0 END) AS mobile,
    SUM(CASE WHEN platform = 'desktop' THEN amount ELSE 0 END) AS desktop
FROM Spending
GROUP BY user_id, spend_date
```  

| user_id | spend_date | mobile | desktop |
| ------- | ---------- | ------ | ------- |
| 1       | 2019-07-01 | 100    | 100     |
| 2       | 2019-07-01 | 100    | 0       |
| 2       | 2019-07-02 | 100    | 0       |
| 3       | 2019-07-01 | 0      | 100     |
| 3       | 2019-07-02 | 0      | 100     |  

ë‹¤ìŒê³¼ ê°™ì´, ê° `user_id, spend_date` ë³„ë¡œ Mobile, desktopì— í•´ë‹¹í•˜ëŠ” Spendì„ êµ¬í•˜ëŠ” ì§‘ê³„ ë°ì´í„°ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.      
ì´ì œ ì—¬ê¸°ì„œ ë„ì¶œëœ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ `both` ì»¬ëŸ¼ì„ ì§‘ê³„í•´ì•¼ í•©ë‹ˆë‹¤.  

<br/>

#### STEP. 2 [both ë°ì´í„°ì™€, total_amount ì»¬ëŸ¼ ì§‘ê³„]  


```sql
SELECT *,
    IF(mobile > 0, IF(desktop > 0, 'both', 'mobile'), 'desktop') AS platform,
    (mobile+desktop) AS total_amount
FROM 
    (
    SELECT user_id, spend_date,
        SUM(CASE WHEN platform = 'mobile' THEN amount ELSE 0 END) AS mobile,
        SUM(CASE WHEN platform = 'desktop' THEN amount ELSE 0 END) AS desktop
    FROM Spending
    GROUP BY user_id, spend_date
) T1
```

| user_id | spend_date | mobile | desktop | platform | total_amount |
| ------- | ---------- | ------ | ------- | -------- | ------------ |
| 1       | 2019-07-01 | 100    | 100     | both     | 200          |
| 2       | 2019-07-01 | 100    | 0       | mobile   | 100          |
| 2       | 2019-07-02 | 100    | 0       | mobile   | 100          |
| 3       | 2019-07-01 | 0      | 100     | desktop  | 100          |
| 3       | 2019-07-02 | 0      | 100     | desktop  | 100          |  

ì´ì œ, mobile ì»¬ëŸ¼ê³¼ desktop ì»¬ëŸ¼ì˜ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ Platform ì»¬ëŸ¼ì— `user_id`ê°€ ê°€ì§€ê³  ìˆëŠ” ìƒíƒœë¥¼ ì •ì˜í•©ë‹ˆë‹¤.  

* IF(mobile > 0, IF(desktop > 0, 'both', 'mobile'), 'desktop') AS platform // mobile, desktopì˜ ë°ì´í„°ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë¬¸ìì—´ ì‚½ì…  
* (mobile+desktop) AS total_amount // spend ì»¬ëŸ¼ì˜ í•©ì‚° 

<br/>


#### STEP. 3 [2019-07-02ì˜ both ìƒì„±ì„ ìœ„í•œ union data]  


```sql
SELECT DISTINCT spend_date, 'desktop' platform FROM Spending
UNION ALL
SELECT DISTINCT spend_date, 'mobile' platform FROM Spending
UNION ALL
SELECT DISTINCT spend_date, 'both' platform FROM Spending
```  

| spend_date | platform |
| ---------- | -------- |
| 2019-07-01 | desktop  |
| 2019-07-02 | desktop  |
| 2019-07-01 | mobile   |
| 2019-07-02 | mobile   |
| 2019-07-01 | both     |
| 2019-07-02 | both     |  

STEP.2 ì—ì„œ ì§‘ê³„í•œ ë°ì´í„°ì—ëŠ” ì‹¤ì œ ë°œìƒí•œ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì§‘ê³„í•˜ê¸°ì—, `2019-07-02`ì¼ì— bothê°€ ì—†ëŠ” ê²½ìš° ë”°ë¡œ ì¶œë ¥ì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.  
ë”°ë¼ì„œ, ë‹¨ìˆœí•˜ê²Œ `Spending` Tableì—ì„œ ë¬¸ìì—´ì„ ì¶”ê°€í•œ ë°ì´í„° ëª¨ìŒì„ ê¸°ì¤€ìœ¼ë¡œ Join í•´ì•¼ í•©ë‹ˆë‹¤.  

<br/>




#### STEP. 4 [LEFT JOIN]  


```sql  
SELECT * FROM 
(
    SELECT DISTINCT spend_date, 'desktop' platform FROM Spending
    UNION ALL
    SELECT DISTINCT spend_date, 'mobile' platform FROM Spending
    UNION ALL
    SELECT DISTINCT spend_date, 'both' platform FROM Spending
) P1
LEFT JOIN (
    SELECT *,
        IF(mobile > 0, IF(desktop > 0, 'both', 'mobile'), 'desktop') AS platform,
        (mobile+desktop) AS total_amount
    FROM 
        (
        SELECT user_id, spend_date,
            SUM(CASE WHEN platform = 'mobile' THEN amount ELSE 0 END) AS mobile,
            SUM(CASE WHEN platform = 'desktop' THEN amount ELSE 0 END) AS desktop
        FROM Spending
        GROUP BY user_id, spend_date
    ) T1
) T2
ON P1.platform = T2.platform AND P1.spend_date = T2.spend_date
```

| spend_date | platform | user_id | spend_date | mobile | desktop | platform | total_amount |
| ---------- | -------- | ------- | ---------- | ------ | ------- | -------- | ------------ |
| 2019-07-01 | desktop  | 3       | 2019-07-01 | 0      | 100     | desktop  | 100          |
| 2019-07-02 | desktop  | 3       | 2019-07-02 | 0      | 100     | desktop  | 100          |
| 2019-07-01 | mobile   | 2       | 2019-07-01 | 100    | 0       | mobile   | 100          |
| 2019-07-02 | mobile   | 2       | 2019-07-02 | 100    | 0       | mobile   | 100          |
| 2019-07-01 | both     | 1       | 2019-07-01 | 100    | 100     | both     | 200          |
| 2019-07-02 | both     | null    | null       | null   | null    | null     | null         |  

LEFT JOINìœ¼ë¡œ `spend_date, platform`ì´ ë™ì¼í•œ ê²½ìš°ì˜ ë°ì´í„°ë¥¼ Join í–ˆê¸°ì—, ë‹¤ìŒê³¼ ê°™ì´ `2019-07-02`ë„ ì •ìƒì ìœ¼ë¡œ í‘œí˜„ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.  
ì´ì œ ì´ ë°ì´í„°ë“¤ì„ ì •ë‹µì— ì•Œë§ê²Œ ì •ì œí•˜ëŠ” ê³¼ì •ì„ ì„ìœ¼ë©´ ë©ë‹ˆë‹¤.  

<br/>



#### STEP. 5 [GROUP BY ì§‘ê³„]  


```sql
SELECT P1.spend_date, P1.platform, IFNULL(SUM(T2.total_amount), 0) AS total_amount, COUNT(user_id) total_users
FROM (
    SELECT DISTINCT spend_date, 'desktop' platform FROM Spending
    UNION ALL
    SELECT DISTINCT spend_date, 'mobile' platform FROM Spending
    UNION ALL
    SELECT DISTINCT spend_date, 'both' platform FROM Spending
) P1
LEFT JOIN (
    SELECT *,
        IF(mobile > 0, IF(desktop > 0, 'both', 'mobile'), 'desktop') AS platform,
        (mobile+desktop) AS total_amount
    FROM 
        (
        SELECT user_id, spend_date,
            SUM(CASE WHEN platform = 'mobile' THEN amount ELSE 0 END) AS mobile,
            SUM(CASE WHEN platform = 'desktop' THEN amount ELSE 0 END) AS desktop
        FROM Spending
        GROUP BY user_id, spend_date
    ) T1
) T2
ON P1.platform = T2.platform AND P1.spend_date = T2.spend_date
GROUP BY spend_date, platform
```

| spend_date | platform | total_amount | total_users |
| ---------- | -------- | ------------ | ----------- |
| 2019-07-01 | desktop  | 100          | 1           |
| 2019-07-02 | desktop  | 100          | 1           |
| 2019-07-01 | mobile   | 100          | 1           |
| 2019-07-02 | mobile   | 100          | 1           |
| 2019-07-01 | both     | 200          | 1           |
| 2019-07-02 | both     | 0            | 0           |  

ìµœì¢…ì ìœ¼ë¡œ `GROUP BY spend_date, platform`ë¡œ ì§‘ê³„í•  ìœ ë‹ˆí¬í•œ ê¸°ì¤€ ì»¬ëŸ¼ìœ¼ë¡œ Groupingì„ í•œ ë’¤ ì§‘ê³„í•©ë‹ˆë‹¤.  

 * IFNULL(SUM(T2.total_amount), 0) AS total_amount // ì´ spend í•©
 * COUNT(user_id) total_users // user í•©
